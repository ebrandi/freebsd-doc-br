<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!--
  The FreeBSD Documentation Project
  The FreeBSD Brazilian Portuguese Documentation Project

  Original revision: r39544

  $FreeBSD$
-->

<!-- Need more documentation on praudit, auditreduce, etc.  Plus more info
on the triggers from the kernel (log rotation, out of space, etc).
And the /dev/audit special file if we choose to support that.  Could use
some coverage of integrating MAC with Event auditing and perhaps discussion
on how some companies or organizations handle auditing and auditing
requirements. -->

<chapter id="audit">
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Tom</firstname>
	<surname>Rhodes</surname>
	<contrib>Uma Contribuição de </contrib>
      </author>
      <author>
	<firstname>Robert</firstname>
	<surname>Watson</surname>
      </author>
    </authorgroup>
  </chapterinfo>

  <title>Evento de Segurança e Auditoria</title>

  <sect1 id="audit-synopsis">
    <title>Sinopse</title>

    <indexterm><primary>AUDIT</primary></indexterm>
    <indexterm>
      <primary>Evento de Segurança e Auditoria</primary>
      <see>MAC</see>
    </indexterm>

    <para>O sistema operacional &os; inclui suporte à ajuste fino nos 
      eventos de segurança e auditoria. Eventos de auditoria permitem 
      ajuste fino, confiável e configurável de registro de uma variedade 
      de eventos do sistema relevantes à segurança, incluindo logins, 
      alterações de configuração e arquivos, bem como acesso a rede.
      Estes registros de log podem ser inestimáveis aos sistemas de 
      monitoramento online, de detecção de intrusão e análises de postmortem.
      &os; implementa a API e formato de arquivo <acronym>BSM</acronym> 
      publicados pela &sun; e é interoperável com ambas implementações
      de auditoria X dos sistemas &solaris; da &sun; e &macos; da &apple;.</para>

    <para>Este capítulo foca na instalação e configuração dos Eventos de Auditoria, explica sobre as suas politicas e fornece exemplos de configuração.</para>

    <para>Após ler este capítulo você irá saber:</para>

    <itemizedlist>
      <listitem>
        <para>O que é e como a auditoria de eventos funciona.</para>
      </listitem>

      <listitem>
	<para>Como configurar Eventos de Auditoria para usuários e processos no &os;.</para>
      </listitem>

      <listitem>
	<para>Como revisar os rastros de auditoria utilizando as ferramentas de redução e revisão.</para>
      </listitem>
    </itemizedlist>

    <para>Antes de ler este capítulo você deveria:</para>

    <itemizedlist>
      <listitem>
	<para>Entender o básico de &unix; e &os;
	  (<xref linkend="basics"/>).</para>
      </listitem>

      <listitem>
	<para>Estar familiarizado com o básico sobre configuração/compilação(<xref linkend="kernelconfig"/>) de kernel.</para>
      </listitem>

      <listitem>
	<para>Ter alguma familiaridade com segurança e o seu funcionamento no &os; (<xref linkend="security"/>).</para>
      </listitem>
    </itemizedlist>

    <warning>
      <para>O serviço de auditoria tem algumas limitações conhecidas
  tal qual nem todos os eventos relevantes de segurança podem ser
  auditaveis, alguns mecanismos de autenticação como os baseados no
  gerenciamento de telas x11 e outros daemons de terceiros não 
  configuram propriamente o serviço de auditoria nas sessões de 
  autenticação dos usuários.</para>

      <para>Os eventos de auditoria e segurança são capazes de gerar logs 
  detalhados das atividades do sistema: em um sistema movimentado dados 
  referentes ao rastreio de um arquivo podem se tornar muito grandes quando 
  configurados com muitos detalhes excedendo gigabytes em uma semana em 
  algumas configurações. Administradores devem considerar os requerimentos 
  de espaço em disco associados ao alto volume de dados gerados devido ao 
  tipo de configuração de auditoria. Por exemplo, é desejável que se dedique
  um file system à arvore <filename>/var/audit</filename>, dessa
  maneira outros file systems não são afetados caso o file system de 
  auditoria fique cheio.</para>
    </warning>

  </sect1>

  <sect1 id="audit-inline-glossary">
    <title>Termos chave neste capítulo</title>

    <para>Antes de ler este capítulo alguns termos chave relacionados a 
      auditoria precisam ser explicados:</para>

    <itemizedlist>
      <listitem>
	<para><emphasis>evento</emphasis>: Um evento auditavel é qualquer
    evento que possa ser logado utilizando o subsistema de auditoria.

    Exemplos relevantes de eventos de segurança incluem a criação de
    um arquivo, criar uma conexão de rede ou o login de um usuário.

    Eventos podem ser <quote>atribuíveis</quote>, o que significa
	  poder ser rastreado a um usuário autenticado ou 
	  <quote>não atribuíveis</quote> significando que não podem.

    Exemplos de eventos não atribuíveis são aqueles que ocorrem
    antes da autenticação no processo de login, tal qual tentativas
    invalidas de senha.</para>
      </listitem>

      <listitem>
        <para><emphasis>classe</emphasis>: Classes de evento são 
    conjuntos de nomes de eventos relacionados e são utilizados 
    nas expressões de seleção.
    Classes de evento geralmente utilizadas são <quote>file creation</quote>
    (fc), <quote>exec</quote> (ex) e <quote>login_logout</quote> (lo).</para>
      </listitem>

      <listitem>
	<para><emphasis>registro</emphasis>: Um registro é uma entrada no 
    no log de auditoria descrevendo um evento de segurança. Registros
    contém um campo do tipo de evento, informação do assunto (usuário)
    ocasionando a ação, informação de data e hora, informação de 
    qualquer objeto ou argumentos e uma condição de sucesso ou falha.</para>
      </listitem>

      <listitem>
	<para><emphasis>rastro</emphasis>: Um rastro de auditoria ou 
    arquivo de log consiste em uma série de registros de auditoria
    descrevendo eventos de segurança. Normalmente os rastros estão em
    ordem cronológica respeitando o horário dos eventos completos.
    Somente processos autorizados são autorizados a realizar 
    registro nos rastros de auditoria.</para>
      </listitem>

      <listitem>
	<para><emphasis>expressões de seleção</emphasis>: Uma expressão de 
    seleção é uma string contendo uma lista de prefixos e nomes de classes 
    de evento de auditoria utilizados para combinar eventos.</para>
      </listitem>

      <listitem>
	<para><emphasis>pré-seleção</emphasis>: Processo pelo qual o sistema
    identifica quais eventos são de interesse do administrador afim de 
    evitar gerar registros de auditoria descrevendo eventos que não são 
    de seu interesse. A configuração de pré-seleção utiliza uma série
    de expressões de seleção para identificar quais classes de eventos 
    auditar para quais usuários, bem como as configurações globais que
    se aplicam tanto aos processos autenticados quanto aos não 
    autenticados.</para>
      </listitem>

      <listitem>
	<para><emphasis>redução</emphasis>: Processo o qual registros dos 
    rastros de auditoria existentes são selecionados à serem preservados, 
    impressos ou analisados. Bem como o processo pelo qual registros
    indesejados de auditoria são removidos dos rastros de auditoria.
    Utilizando redução os administradores podem implementar politicas 
    para preservar os dados de auditoria. Por exemplo, rastros detalhados
    de auditoria poderiam ser mantidos por um mês, porém, após isso os 
    rastros poderiam ser reduzidos afim de preservar somente as informações 
    de login para propósito de arquivo .</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 id="audit-install">
    <title>Instalando Suporte de Auditoria</title>

    <para>User space support for Event Auditing is installed as part of the
      base &os; operating system.  Kernel support for
      Event Auditing is compiled in by default, but support for this
      feature must be explicitly compiled into the custom kernel by adding
      the following line to the kernel configuration file:</para>

    <programlisting>options	AUDIT</programlisting>

    <para>Rebuild and reinstall
      the kernel via the normal process explained in
      <xref linkend="kernelconfig"/>.</para>

    <para>Once an audit-enabled kernel is built, installed, and the system
      has been rebooted, enable the audit daemon by adding the following line
      to &man.rc.conf.5;:</para>

    <programlisting>auditd_enable="YES"</programlisting>

    <para>O suporte de Auditoria deve ser iniciado pela reinicialização do
      sistema ou manualmente iniciando o daemon de auditoria:</para>

    <programlisting>/etc/rc.d/auditd start</programlisting>
  </sect1>

  <sect1 id="audit-config">
    <title>Configuração de Auditoria</title>

    <para>Todos os arquivos de configuração para auditoria de segurança são
      encontrados em <filename class="directory">/etc/security</filename>.
      Os seguintes arquivos precisam estar presentes antes que o daemon de 
      auditoria seja iniciado:</para>

    <itemizedlist>
      <listitem>
	<para><filename>audit_class</filename> - Contem as definições
	  das classes de auditoria.</para>
      </listitem>

      <listitem>
	<para><filename>audit_control</filename> - Controla os aspectos
	  do subsistema de auditoria, como as classes padrão,
    quantidade minima de espaço em disco para se deixar no
    volume de log de auditoria, quantidade maxima do 
    tamanho dos rastros de auditoria, etc.</para>
      </listitem>

      <listitem>
	<para><filename>audit_event</filename> - Nomes textuais e 
	  descrições dos eventos de auditoria, bem como a lista de
    qual classe cada evento faz parte.</para>
      </listitem>

      <listitem>
	<para><filename>audit_user</filename> - Requerimentos de
    auditoria especificos de usuÃ¡rio que são combinados com o
    padrão global no momento de login.</para>
      </listitem>

      <listitem>
	<para><filename>audit_warn</filename> - Um shell script
    customizado utilizado por <application>auditd</application> para
    gerar mensagens de alerta em situações excepcionais, tais como
    quando o espaço para armazenar os registros de auditoria estiver baixo
    ou quando o arquivo de rastros de auditoria for rotacionado.</para>
      </listitem>
    </itemizedlist>

    <warning>
      <para>Os arquivos de configuração de auditoria devem ser editados e 
  mantidos cuidadosamente, ja que erros de configuração podem resultar no
  registro impróprio dos eventos.</para>
    </warning>

    <sect2>
      <title>Expressões de Seleção de Eventos</title>

      <para>Expressões de Seleção são utilizadas em diversos lugares 
	na configuração de auditoria para determinar quais eventos 
	devem serauditados. As expressões contém uma lista de classes 
	de eventos a serem atendidos, cada um com um prefixo que 
	indica se os registros correspondentes devem ser aceitos ou 
	ignoradas e, opcionalmente, indicam se estes registros 
	consideram operações bem sucedidas ou operações que apresentaram 
	alguma falha. Expressões de Seleção são avaliadas da esquerda 
	para a direita. Duas expressões são combinadas anexando-se 
	uma a outra.</para>

      <para>A seguinte lista contém as classes de evento de auditoria 
	padrão presentes em <filename>audit_class</filename>:</para>

      <itemizedlist>
	<listitem>
	  <para><literal>all</literal> - <emphasis>all</emphasis> - 
	    Corresponde a todas as classes.</para>
	</listitem>

	<listitem>
	  <para><literal>ad</literal> - <emphasis>administrative</emphasis> - 
	    Ações administrativas realizadas no sistema como um todo.</para>
	</listitem>

	<listitem>
	  <para><literal>ap</literal> - <emphasis>application</emphasis> -
	    Application defined action.</para>
	</listitem>

	<listitem>
	  <para><literal>cl</literal> - <emphasis>file close</emphasis> -
	    Audita chamadas de sistema <literal>(syscalls)</literal> 
	    da função <function>close</function>.</para>
	</listitem>

	<listitem>
	  <para><literal>ex</literal> - <emphasis>exec</emphasis> - 
	    Audita execução de programas.  Auditorias de argumentos 
	    repassados em linha de comando e variaveis de ambiente 
	    são controladas via &man.audit.control.5; com auxílio 
	    das políticas de <literal>argv</literal> e <literal>envv</literal>
	    repassadas para a configuração de <literal>policy</literal>.</para>
	</listitem>

	<listitem>
	  <para><literal>fa</literal> - <emphasis>file attribute access</emphasis> - 
	    Audita o acesso a atributos de objetos como 
	    &man.stat.1;, &man.pathconf.2; e eventos similares.</para>
	</listitem>

	<listitem>
	  <para><literal>fc</literal> - <emphasis>file create</emphasis> - 
	    Audita eventos que resultaram na criação de um arquivo.</para>
	</listitem>

	<listitem>
	  <para><literal>fd</literal> - <emphasis>file delete</emphasis> - 
	    Audita eventos que resultaram na deleção de um arquivo.</para>
	</listitem>

	<listitem>
	  <para><literal>fm</literal> - <emphasis>file attribute modify</emphasis> - 
	    Audita eventos onde houve modificação de atributos/permissões de 
	    arquivos através de &man.chown.8;, &man.chflags.1;, &man.flock.2;,
	    etc.</para>
	</listitem>

	<listitem>
	  <para><literal>fr</literal> - <emphasis>file read</emphasis> - 
	    Audita eventos onde houve acesso de abertura a dados/arquivos, leitura 
	    de arquivos, etc.</para>
	</listitem>

	<listitem>
	  <para><literal>fw</literal> - <emphasis>file write</emphasis> -
	    Audita eventos onde houve escrita ou modificação de dados/arquivos e etc.</para>
	</listitem>

	<listitem>
	  <para><literal>io</literal> - <emphasis>ioctl</emphasis> - 
	    Audita uso da chamada de sistema (<literal>syscall</literal>) &man.ioctl.2;.</para>
	</listitem>

	<listitem>
	  <para><literal>ip</literal> - <emphasis>ipc</emphasis> - 
	    Audita várias formas de Comunicação Inter-Processos, incluindo pipes POSIX
	    e operações <acronym>IPC</acronym> em System V.</para>
	</listitem>

	<listitem>
	  <para><literal>lo</literal> - <emphasis>login_logout</emphasis> -
	    Audita eventos onde ocorra uso de &man.login.1; e &man.logout.1; no sistema.</para>
	</listitem>

	<listitem>
	  <para><literal>na</literal> - <emphasis>non attributable</emphasis> -
	    Audita eventos não atribuíveis.</para>
	</listitem>

	<listitem>
	  <para><literal>no</literal> - <emphasis>invalid class</emphasis> -
	    Não corresponde a evento de auditoria algum.</para>
	</listitem>

	<listitem>
	  <para><literal>nt</literal> - <emphasis>network</emphasis> -
	    Audita eventos relacionados a atividades de rede, tais 
	    como as chamadas de sistema (<literal>syscalls</literal>) 
	    &man.connect.2; e &man.accept.2;.</para>
	</listitem>

	<listitem>
	  <para><literal>ot</literal> - <emphasis>other</emphasis> -
	    Audita eventos diversos.</para>
	</listitem>

	<listitem>
	  <para><literal>pc</literal> - <emphasis>process</emphasis> -
	    Audita operações ligadas a processos, tais como &man.exec.3; a
	    &man.exit.3;.</para>
	</listitem>

      </itemizedlist>

      <para>Estes eventos de auditoria podem ser customizados se 
	você modificar as configurações nos arquivos 
	<filename>audit_class</filename> e <filename>audit_event</filename>.</para>

      <para>Cada classe de auditoria nesta lista é combinada com um 
	prefixo indicando onde uma operação (bem ou mal sucedida) 
	deve ser considerada e se um novo registro é adicionado ou 
	removido para determinada classe e tipo.</para>

      <itemizedlist>
	<listitem>
	  <para><literal>(none)</literal> Audita ambos os casos de 
	    um evento; bem sucedidos e mal sucedidos.</para>
	</listitem>

	<listitem>
	  <para><literal>+</literal> Audita eventos bem sucedidos.</para>
	</listitem>

	<listitem>
	  <para><literal>-</literal> Audita eventos mal sucedidos.</para>
	</listitem>

	<listitem>
	  <para><literal>^</literal> Não audita evento algum.</para>
	</listitem>

	<listitem>
	  <para><literal>^+</literal> Não audita eventos bem sucedidos.</para>
	</listitem>

	<listitem>
	  <para><literal>^-</literal> Não audita eventos mal sucedidos.</para>
	</listitem>

      </itemizedlist>

      <para>O exemplo a seguir seleciona tanto sucesso como falhas 
	dos eventos de login/logout, mas apenas eventos bem sucedidos 
	de execuções de programas:</para>

      <programlisting>lo,+ex</programlisting>

    </sect2>

    <sect2>
      <title>Arquivos de Configuração</title>

      <para>In most cases, administrators will need to modify only two files
	when configuring the audit system: <filename>audit_control</filename>
	and <filename>audit_user</filename>.  The first controls system-wide
	audit properties and policies; the second may be used to fine-tune
	auditing by user.</para>

      <sect3 id="audit-auditcontrol">
        <title>The <filename>audit_control</filename> File</title>

	<para>The <filename>audit_control</filename> file specifies a number
	  of defaults for the audit subsystem.  Viewing the contents of this
	  file, we see the following:</para>

	<programlisting>dir:/var/audit
flags:lo
minfree:20
naflags:lo
policy:cnt
filesz:0</programlisting>

	<para>The <option>dir</option> option is used to set one or more
	  directories where audit logs will be stored.  If more than one
	  directory entry appears, they will be used in order as they fill.
	  It is common to configure audit so that audit logs are stored on
	  a dedicated file system, in order to prevent interference between
	  the audit subsystem and other subsystems if the file system fills.
	  </para>

	<para>The <option>flags</option> field sets the system-wide default
	  preselection mask for attributable events.  In the example above,
	  successful and failed login and logout events are audited for all
	  users.</para>

	<para>The <option>minfree</option> option defines the minimum
	  percentage of free space for the file system where the audit trail
	  is stored.  When this threshold is exceeded, a warning will be
	  generated.  The above example sets the minimum free space to
	  twenty percent.</para>

	<para>The <option>naflags</option> option specifies audit classes to
	  be audited for non-attributed events, such as the login process
	  and system daemons.</para>

	<para>The <option>policy</option> option specifies a comma-separated
	  list of policy flags controlling various aspects of audit
	  behavior.  The default <literal>cnt</literal> flag indicates that
	  the system should continue running despite an auditing failure
	  (this flag is highly recommended).  Another commonly used flag is
	  <literal>argv</literal>, which causes command line arguments to
	  the &man.execve.2; system call to be audited as part of command
	  execution.</para>

	<para>The <option>filesz</option> option specifies the maximum size
	  in bytes to allow an audit trail file to grow to before
	  automatically terminating and rotating the trail file.  The
	  default, 0, disables automatic log rotation.  If the requested
	  file size is non-zero and below the minimum 512k, it will be
	  ignored and a log message will be generated.</para>
      </sect3>

      <sect3 id="audit-audituser">
	<title>O Arquivo <filename>audit_user</filename></title>

	<para>The <filename>audit_user</filename> file permits the
	  administrator to specify further audit requirements for specific
	  users.
	  Each line configures auditing for a user via two fields: the
	  first is the <literal>alwaysaudit</literal> field, which specifies
	  a set of events that should always be audited for the user, and
	  the second is the <literal>neveraudit</literal> field, which
	  specifies a set of events that should never be audited for the
	  user.</para>

	<para>The following example <filename>audit_user</filename> file
	  audits login/logout events and successful command execution for
	  the <username>root</username> user, and audits file creation and successful command
	  execution for the <username>www</username> user.
	  If used with the example <filename>audit_control</filename> file
	  above, the <literal>lo</literal> entry for <username>root</username>
	  is redundant, and login/logout events will also be audited for the
	  <username>www</username> user.</para>

	<programlisting>root:lo,+ex:no
www:fc,+ex:no</programlisting>

      </sect3>
    </sect2>
  </sect1>

  <sect1 id="audit-administration">
    <title>Administrando o Sistema de Auditoria</title>

    <sect2>
      <title>Consultando Rastros de Auditoria</title>

      <para>Audit trails are stored in the BSM binary format, so tools must
	be used to modify or convert to text.  The &man.praudit.1;
	command converts trail files to a simple text format; the
	&man.auditreduce.1; command may be used to reduce the
	audit trail file for analysis, archiving, or printing purposes.
	<command>auditreduce</command> supports a variety of selection
	parameters, including event type, event class, user, date or time of
	the event, and the file path or object acted on.</para>

      <para>For example, the <command>praudit</command> utility will dump
	the entire contents of a specified audit log in plain text:</para>

      <screen>&prompt.root; <userinput>praudit /var/audit/AUDITFILE</userinput></screen>

      <para>Where <filename><replaceable>AUDITFILE</replaceable></filename> is the audit log to
	dump.</para>

      <para>Audit trails consist of a series of audit records made up of
	tokens, which <command>praudit</command> prints sequentially one per
	line.  Each token is of a specific type, such as
	<literal>header</literal> holding an audit record header, or
	<literal>path</literal> holding a file path from a name
	lookup.  The following is an example of an
	<literal>execve</literal> event:</para>

      <programlisting>header,133,10,execve(2),0,Mon Sep 25 15:58:03 2006, + 384 msec
exec arg,finger,doug
path,/usr/bin/finger
attribute,555,root,wheel,90,24918,104944
subject,robert,root,wheel,root,wheel,38439,38032,42086,128.232.9.100
return,success,0
trailer,133</programlisting>

      <para>This audit represents a successful <literal>execve</literal>
	call, in which the command <literal>finger doug</literal> has been run.  The
	arguments token contains both the processed command line presented
	by the shell to the kernel.  The <literal>path</literal> token holds the path to the
	executable as looked up by the kernel.  The <literal>attribute</literal> token
	describes the binary, and in particular, includes the file mode
	which can be used to determine if the application was setuid.
	The <literal>subject</literal> token describes the subject process, and stores in
	sequence the audit user ID, effective user ID and group ID, real
	user ID and group ID, process ID, session ID, port ID, and login
	address.  Notice that the audit user ID and real user ID differ:
	the user <username>robert</username> has switched to the
	<username>root</username> account before running this command, but
	it is audited using the original authenticated user.  Finally, the
	<literal>return</literal> token indicates the successful execution, and the <literal>trailer</literal>
	concludes the record.</para>

      <para><command>praudit</command> also supports
	an XML output format, which can be selected using the
	<option>-x</option> argument.</para>

    </sect2>

    <sect2>
      <title>Reduzindo Rastros de Auditoria</title>

      <para>Since audit logs may be very large, an administrator will
	likely want to select a subset of records for using, such as records
	associated with a specific user:</para>

      <screen>&prompt.root; <userinput>auditreduce -u trhodes /var/audit/AUDITFILE | praudit</userinput></screen>

      <para>This will select all audit records produced for the user
	<username>trhodes</username> stored in the
	<filename><replaceable>AUDITFILE</replaceable></filename> file.</para>
    </sect2>

    <sect2>
      <title>Delegando Direitos de Revisão</title>

      <para>Membros do grupo <groupname>audit</groupname> têm permissão 
	para ler rastros/arquivos (<literal>trails</literal>) de auditoria 
	disponíveis em <filename>/var/audit</filename>. Por padrão, este 
	grupo está vazio. Portanto, inicialmente, apenas o usuário 
	<username>root</username> terá este tipo de privilégio. Outros usuários 
	podem ser adicionados ao grupo <groupname>audit</groupname> a fim de 
	delegar direitos de revisão de auditoria a estes usuários. Como os 
	privilégios de verificar o conteúdo dos logs de auditoria fornece uma 
	visão significativa no comportamento dos utilizadores e dos processos 
	do sistema, é recomendado que a delegação destes privilégios de 
	auditoria seja realizada com muita cautela.</para>
    </sect2>

    <sect2>
      <title>Monitoramento em Tempo Real com Audit Pipes</title>

      <para><literal>Audit Pipes</literal> são <quote>pseudo-devices</quote> 
	disponíveis na árvore de dispositivos do sistema de arquivos 
	que permitem que aplicativos aproveitem a transmissão ao vivo 
	de registros de auditoria. Este é um dos principais interesses 
	no uso conjunto com sistemas de detecção de intrusão e aplicações 
	de monitoramento. Entretanto, para o administrador do sistema os 
	<literal>Audit Pipes</literal> são uma forma conveniente para 
	permitir o monitoramento ao vivo sem enfrentar problemas com 
	permissões dos arquivos de auditoria ou rotação de logs, 
	interrompendo o fluxo de eventos de auditoria. Para acompanhar 
	a auditoria ao vivo, execute o seguinte comando:</para>

      <screen>&prompt.root; <userinput>praudit /dev/auditpipe</userinput></screen>

      <para>Por padrão, estes <quote>pseudo-devices</quote> são 
	acessíveis apenas pelo usuário <username>root</username>. Para 
	torná-los acessíveis aos membros do grupo 
	<groupname>audit</groupname>, adicione uma regra de 
	<literal>devfs</literal> em 
	<filename>/etc/devfs.rules</filename>: </para>

      <programlisting>add path 'auditpipe*' mode 0440 group audit</programlisting>

      <para>Consulte a página de manual &man.devfs.rules.5; para obter 
	mais informações e detalhes de como configurar regras de 
	<literal>devfs</literal> em seu sistema.</para>

      <warning>
        <para>É fácil produzir ciclos de feedbacks de eventos de 
	  auditoria onde a visualização destes eventos pode gerar novos 
	  eventos de auditoria. Por exemplo, se toda a atividade de 
	  rede estiver sendo auditada e o &man.praudit.1; for executado 
	  a partir de uma sessão SSH, então um fluxo contínuo de eventos 
	  de auditoria será gerado a uma taxa elevada, já que cada 
	  evento sendo impresso irá gerar outro evento. A fim de evitar 
	  que isso aconteça, é aconselhável executar o 
	  <command>praudit</command> em um <literal>Audit Pipe</literal> 
	  em sessões que não gerem novos eventos de auditoria; 
	  sessões com baixo índice de granularidade de auditoria.</para>
      </warning>
    </sect2>

    <sect2>
      <title>Rotacionando Arquivos de Auditoria</title>

     <para>Rastros (<literal>trails</literal>) de auditoria são escritos 
	apenas pelo kernel, e gerenciados apenas pelo daemon de auditoria, 
	o <application>auditd</application>. Administradores não devem 
	tentar usar o &man.newsyslog.conf.5; ou outras ferramentas para 
	rotacionar logs e rastros de auditoria. Em vez disso, o comando 
	<command>audit</command> pode ser utilizado como uma ferramenta de 
	gestão para realizar rotação de logs, além de poder encerrar a 
	auditoria ou reconfigurar o sistema de auditoria. O comando 
	exemplificado abaixo, faz com que um novo registro de log seja 
	criado e sinaliza ao kernel para que o use. O antigo log será 
	encerrado e renomeado, podendo, assim, ser manipulado pelo 
	administrador.</para>

      <screen>&prompt.root; <userinput>audit -n</userinput></screen>

      <warning>
	<para>Se o <application>auditd</application> não estiver em execução 
	  no momento, este comando irá produzir uma mensagem de erro.</para>
      </warning>

      <para>Adicionar a seguinte linha ao arquivo
	<filename>/etc/crontab</filename> forçará a rotação dos arquivos
	a cada 12 (doze) horas com auxílio do &man.cron.8;:</para>

      <programlisting>0     */12       *       *       *       root    /usr/sbin/audit -n</programlisting>

      <para>As alterações terão efeito assim que você salvar o arquivo.</para>

      <para>Rotação automática do arquivo de auditoria com base no 
	tamanho do arquivo é possível de se realizar através da opção 
	<option>filesz</option> em &man.audit.control.5;, descrita 
	na seção de arquivos de configuração deste capítulo.</para>

    </sect2>

    <sect2>
      <title>Compactação dos Rastros de Auditoria</title>

      <para>Visto que os arquivos de auditoria podem se tornar muito 
	grandes, muitas vezes é desejável que estes arquivos e seus 
	rastros <literal>(trails)</litera> sejam compactados ou 
	armazenados em um outro local/dispositivo uma vez que já 
	foram utilizados pelo daemon de auditoria. O script 
	<filename>audit_warn </filename> pode ser utilizado para 
	realizar operações personalizadas para uma variedade de 
	eventos relacionados a auditoria, incluindo a rescisão de 
	rastros de auditoria quando rotacionados. O seguinte conteúdo 
	pode, por exemplo, ser adicionado ao <filename>audit_warn</filename> 
	para compactar rastros de auditoria após uso dos arquivos:</para>

      <programlisting>#
# Compress audit trail files on close.
#
if [ "$1" = closefile ]; then
        gzip -9 $2
fi</programlisting>

      <para>Outras atividades podem incluir a cópia dos arquivos para 
	um servidor centralizado, apagar antigos arquivos de rastros 
	ou reduzir rastros de auditoria para remover registros 
	desnecessários. O script será executado apenas quando os arquivos 
	de rastro de auditoria forem rescindidos, por isso não vai ser 
	executado em arquivos de rastro que não forem interpretados 
	até o fim.</para>
    </sect2>
  </sect1>
</chapter>
